<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ElectroPlayground ‚Äî Learn Electronics by Playing</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="site-header">
    <h1>‚ö° ElectroPlayground</h1>
    <p>Build, tweak, and troubleshoot safe virtual circuits. Made for curious minds.</p>
    <div class="header-tools">
      <div class="badges-strip" id="badgesStrip"></div>
      <label class="teen-toggle"><input id="teenMode" type="checkbox"> Teen Mode</label>
      <div class="xp">XP: <strong id="xpVal">0</strong></div>
    </div>
  </header>

  <main class="container">
    <nav class="tabs">
      <button class="tab active" data-tab="builder">1) Build & Blink</button>
      <button class="tab" data-tab="sensor">2) Sensor Lab</button>
      <button class="tab" data-tab="mystery">3) Mystery Fix</button>
<button class="tab" data-tab="logic">4) Logic Lab</button>
<button class="tab" data-tab="pwm">5) PWM Playground</button>
<button class="tab" data-tab="challenges">6) Challenges & Badges</button>
    </nav>

    <!-- TAB 1: Simple circuit builder -->
    <section class="panel active" id="builder">
      <h2>Build & Blink</h2>
      <p class="sub">Connect a battery ‚Üí resistor ‚Üí LED ‚Üí back to battery. Close the switch, then tweak the resistor to keep the LED safe.</p>

      <div class="grid two-col">
        <div>
          <div class="node-list">
            <div class="node" data-node="BAT+">üî∫ BAT +</div>
            <div class="node" data-node="BAT-">üîª BAT ‚àí</div>
            <div class="node" data-node="SW_OUT">‚èª Switch OUT</div>
            <div class="node" data-node="R_OUT">Resistor OUT</div>
            <div class="node" data-node="LED_A">LED Anode (+)</div>
            <div class="node" data-node="LED_C">LED Cathode (‚àí)</div>
          </div>

          <div class="wiring">
            <div class="wire">
              <label>Wire 1:</label>
              <select class="endA"></select> ‚Üí
              <select class="endB"></select>
            </div>
            <div class="wire">
              <label>Wire 2:</label>
              <select class="endA"></select> ‚Üí
              <select class="endB"></select>
            </div>
            <div class="wire">
              <label>Wire 3:</label>
              <select class="endA"></select> ‚Üí
              <select class="endB"></select>
            </div>
            <div class="wire">
              <label>Wire 4:</label>
              <select class="endA"></select> ‚Üí
              <select class="endB"></select>
            </div>
          </div>

          <div class="controls">
            <div class="ctrl">
              <label for="batteryV">Battery: <span id="batteryVLabel">3.0</span> V</label>
              <input id="batteryV" type="range" min="1.5" max="9" step="0.5" value="3" />
            </div>
            <div class="ctrl">
              <label for="resistance">Resistor: <span id="resLabel">330</span> Œ©</label>
              <input id="resistance" type="range" min="10" max="2200" step="10" value="330" />
            </div>
            <div class="ctrl switch">
              <label class="switch-label">
                <input id="switchClosed" type="checkbox" />
                <span>Switch Closed</span>
              </label>
            </div>
            <div class="ctrl">
              <label for="ledVf">LED Forward Voltage: <span id="vfLabel">2.0</span> V</label>
              <input id="ledVf" type="range" min="1.6" max="3.2" step="0.1" value="2.0" />
            </div>
          </div>
        </div>

        <div>
          <div class="preview">
            <div class="led" id="ledViz"></div>
            <div class="gauge">
              <div class="gauge-needle" id="ammeter"></div>
            </div>
          </div>

          <div class="readout" id="readout">
            <div>Current: <strong id="current">0.00</strong> mA</div>
            <div>Power (LED+R): <strong id="power">0.00</strong> mW</div>
            <div class="adv hidden">
              <div>V<sub>R</sub>: <strong id="vR">0.00</strong> V &nbsp; | &nbsp; V<sub>LED</sub>: <strong id="vLED">0.00</strong> V</div>
              <div>Resistor power: <strong id="pR">0.00</strong> mW</div>
              <div class="eqn">I = (V<sub>batt</sub> ‚àí V<sub>f</sub>) / R</div>
            </div>
            <div>Status: <strong id="status">Open circuit</strong></div>
            <details>
              <summary>What‚Äôs happening?</summary>
              <p>This models a simple series circuit. If the switch is closed and wiring creates a loop from BAT+ ‚Üí resistor ‚Üí LED (anode to cathode) ‚Üí BAT‚àí, current flows.</p>
              <p>We estimate current using: <code>I = (Vbatt ‚àí Vf) / R</code> when the LED is forward biased and the switch is closed. If I &gt; 25 mA, that‚Äôs too spicy for most 5&nbsp;mm LEDs.</p>
            </details>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB 2: Sensor lab -->
    <section class="panel" id="sensor">
      <h2>Sensor Lab (Dark Alarm)</h2>
      <p class="sub">Simulate a photoresistor and a threshold knob (potentiometer). If it gets darker than your threshold, the alarm buzzes.</p>

      <div class="grid two-col">
        <div>
          <div class="controls">
            <div class="ctrl">
              <label for="lightLevel">Room Light: <span id="lightLabel">70</span>%</label>
              <input id="lightLevel" type="range" min="0" max="100" step="1" value="70" />
            </div>
            <div class="ctrl">
              <label for="threshold">Threshold (knob): <span id="threshLabel">40</span>%</label>
              <input id="threshold" type="range" min="0" max="100" step="1" value="40" />
            </div>
            <div class="ctrl">
              <label for="volume">Buzzer Volume</label>
              <input id="volume" type="range" min="0" max="1" step="0.01" value="0.25" />
            </div>
          </div>
        </div>
        <div>
          <div class="sensor-viz" id="sensorViz">
            <div class="bulb" id="bulb"></div>
            <div class="buzzer" id="buzzer">üîî</div>
            <div class="sensor-led" id="sensorLed"></div>
          </div>
          <div class="readout" id="sensorReadout">
            <div>Dark? <strong id="isDark">No</strong></div>
            <div>Alarm: <strong id="alarmState">Off</strong></div>
            <details>
              <summary>What‚Äôs happening?</summary>
              <p>Photoresistors change resistance with light. In a voltage divider, the output voltage depends on both resistances. Here we simplify to a % comparison to teach the logic before the math.</p>
            </details>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB 3: Mystery Fix -->
    <section class="panel" id="mystery">
      <h2>Mystery Fix</h2>
      <p class="sub">A simple LED circuit is broken. Use the multimeter to probe two nodes and figure out what‚Äôs wrong. Then apply a fix.</p>

      <div class="grid three-col">
        <div>
          <div class="node-list small">
            <div class="node" data-mnode="M_BAT+">BAT +</div>
            <div class="node" data-mnode="M_BAT-">BAT ‚àí</div>
            <div class="node" data-mnode="M_LED_A">LED A</div>
            <div class="node" data-mnode="M_LED_C">LED C</div>
            <div class="node" data-mnode="M_SW_IN">SW IN</div>
            <div class="node" data-mnode="M_SW_OUT">SW OUT</div>
          </div>

          <div class="meter">
            <div class="probes">
              <label>Probe A:</label>
              <select id="probeA"></select>
              <label>Probe B:</label>
              <select id="probeB"></select>
              <button id="measureBtn">Measure V</button>
              <label class="cont-label"><input id="contMode" type="checkbox"> Continuity</label>
            </div>
            <div class="meter-readout">
              Meter: <strong id="meterVal">0.00 V</strong>
            </div>
          </div>
        </div>

        <div>
          <div class="mystery-status" id="mysteryStatus">
            <div>Fault: <strong id="faultLabel">‚Äî</strong></div>
            <div>LED: <strong id="mysteryLed">Off</strong></div>
            <div>Switch: <strong id="mysterySwitch">Closed</strong></div>
          </div>

          <div class="actions">
            <button id="toggleSwitch">Toggle Switch</button>
            <button id="flipLed">Flip LED</button>
            <button id="replaceBattery">Replace Battery</button>
            <button id="repairWire">Repair Wire</button>
            <button id="newFault">New Puzzle</button>
          </div>
        </div>

        <div>
          <div class="readout">
            <details open>
              <summary>How to solve</summary>
              <ul>
                <li>Measure across the battery: you should see ~Vbatt.</li>
                <li>Measure across the switch: 0 V when closed, ~Vbatt when open if current path exists.</li>
                <li>Across the LED: ~Vf when forward biased; ~0 V if off and same potential; ~Vbatt if open elsewhere.</li>
              </ul>
            </details>
            <div id="win" class="win hidden">üéâ Fixed! Try a new fault.</div>
          </div>
        </div>
      </div>
    </section>
  
    <!-- TAB 4: Logic Lab -->
    <section class="panel" id="logic">
      <h2>Logic Lab</h2>
      <p class="sub">Flip inputs A/B and see how different gates respond. Teen Mode shows truth tables.</p>
      <div class="grid two-col">
        <div class="logic-controls">
          <label>Gate:
            <select id="gate">
              <option>AND</option>
              <option>OR</option>
              <option>NOT</option>
              <option>NAND</option>
              <option>NOR</option>
              <option>XOR</option>
            </select>
          </label>
          <div class="logic-inputs">
            <label class="toggle">A <input id="inA" type="checkbox"></label>
            <label class="toggle">B <input id="inB" type="checkbox"></label>
          </div>
          <div class="logic-output">
            Output: <strong id="logicOut">0</strong>
          </div>
        </div>
        <div class="logic-table adv hidden">
          <table id="truthTable">
            <thead><tr><th>A</th><th>B</th><th>Out</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="readout">
            <details open><summary>Tip</summary>
              <p>NOT ignores B. NAND/NOR flip the result of AND/OR. XOR is true when A and B differ.</p>
            </details>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB 5: PWM Playground -->
    <section class="panel" id="pwm">
      <h2>PWM Playground</h2>
      <p class="sub">Pulse-width modulation: switch power on/off fast. Duty cycle controls average voltage and brightness.</p>
      <div class="grid two-col">
        <div>
          <div class="controls">
            <div class="ctrl">
              <label for="duty">Duty Cycle: <span id="dutyLbl">50</span>%</label>
              <input id="duty" type="range" min="0" max="100" step="1" value="50" />
            </div>
            <div class="ctrl">
              <label for="freq">Frequency: <span id="freqLbl">500</span> Hz</label>
              <input id="freq" type="range" min="50" max="2000" step="10" value="500" />
            </div>
            <div class="ctrl">
              <label for="pwmVolume">Tone Volume</label>
              <input id="pwmVolume" type="range" min="0" max="1" step="0.01" value="0.15" />
            </div>
          </div>
          <div class="readout">
            <div>V<sub>avg</sub> ‚âà Duty √ó V<sub>batt</sub> = <strong id="vavg">0.00</strong> V</div>
            <div>LED Brightness ~ Duty = <strong id="brightPct">50</strong>%</div>
            <details><summary>What‚Äôs happening?</summary>
              <p>PWM turns power on and off rapidly. The LED can‚Äôt respond to each tiny pulse, so it appears dimmer or brighter based on the average.</p>
            </details>
          </div>
        </div>
        <div>
          <div class="pwm-viz">
            <div class="pwm-led" id="pwmLed"></div>
            <div class="pwm-wave">
              <div class="pwm-high" id="pwmHigh"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB 6: Challenges & Badges -->
    <section class="panel" id="challenges">
      <h2>Challenges & Badges</h2>
      <p class="sub">Short missions that prove you understand the concepts. Earn badges and generate study notes.</p>
      <div class="grid two-col">
        <div class="challenge-list">
          <ol id="challengeItems">
            <li data-id="safeCurrent">Set LED current between 10‚Äì15 mA in Build & Blink. <span class="status" id="c_safeCurrent">‚ùå</span></li>
            <li data-id="sensorEdge">Tune the threshold within ¬±1% of light level in Sensor Lab. <span class="status" id="c_sensorEdge">‚ùå</span></li>
            <li data-id="mysteryFix">Fix a Mystery circuit. <span class="status" id="c_mysteryFix">‚ùå</span></li>
            <li data-id="pwm33">Set PWM duty to 33% ¬±1%. <span class="status" id="c_pwm33">‚ùå</span></li>
            <li data-id="xorTrue">In Logic Lab, make XOR output 1 with A‚â†B. <span class="status" id="c_xorTrue">‚ùå</span></li>
          </ol>
          <button id="downloadNotes">Download Study Notes</button>
        </div>
        <div class="badges">
          <div class="badge" id="b_led">üí° LED Tamer</div>
          <div class="badge" id="b_sensor">üëÅÔ∏è Threshold Tuner</div>
          <div class="badge" id="b_fix">üîß Fault Finder</div>
          <div class="badge" id="b_pwm">üì∂ PWM Pilot</div>
          <div class="badge" id="b_logic">üß† Logic Rookie</div>
        </div>
      </div>
    </section>
</main>

  <footer class="site-footer">
    <p>Built for learning by tinkering ‚Äî safely.</p>
  </footer>

  <script>
    // ---------- Tab logic ----------
    const tabs = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('.panel');
    tabs.forEach(btn => btn.addEventListener('click', () => {
      tabs.forEach(b => b.classList.remove('active'));
      panels.forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');
    }));

    // ---------- Populate node dropdowns ----------
    function populateSelects(selects, nodes) {
      selects.forEach(sel => {
        sel.innerHTML = '';
        nodes.forEach(n => {
          const o = document.createElement('option');
          o.value = n;
          o.textContent = n;
          sel.appendChild(o);
        });
      });
    }

    // Tab 1 nodes
    const builderNodes = ['BAT+','BAT-','SW_OUT','R_OUT','LED_A','LED_C'];
    document.querySelectorAll('#builder .wire .endA, #builder .wire .endB')
      .forEach(sel => populateSelects([sel], builderNodes));

    // Tab 3 nodes (mystery)
    const mNodes = ['M_BAT+','M_BAT-','M_LED_A','M_LED_C','M_SW_IN','M_SW_OUT'];
    populateSelects([document.getElementById('probeA'), document.getElementById('probeB')], mNodes);

    // ---------- Builder Simulation ----------
    const batteryV = document.getElementById('batteryV');
    const batteryVLabel = document.getElementById('batteryVLabel');
    const resistance = document.getElementById('resistance');
    const resLabel = document.getElementById('resLabel');
    const switchClosed = document.getElementById('switchClosed');
    const ledVf = document.getElementById('ledVf');
    const vfLabel = document.getElementById('vfLabel');

    const currentEl = document.getElementById('current');
    const powerEl = document.getElementById('power');
    const statusEl = document.getElementById('status');
    const ammeter = document.getElementById('ammeter');
    const ledViz = document.getElementById('ledViz');

    function getWires() {
      const pairs = [];
      document.querySelectorAll('#builder .wire').forEach(w => {
        const a = w.querySelector('.endA').value;
        const b = w.querySelector('.endB').value;
        if (a && b && a !== b) pairs.push([a,b]);
      });
      return pairs;
    }

    function inSameNode(a, b, pairs) {
      // Build connectivity groups
      const nodes = new Set(builderNodes);
      const parent = {};
      builderNodes.forEach(n => parent[n] = n);

      function find(x){ while(parent[x] !== x) x = parent[x]; return x; }
      function union(x,y){ x=find(x); y=find(y); if (x!==y) parent[y]=x; }

      pairs.forEach(([x,y]) => union(x,y));
      return find(a) === find(b);
    }

    function hasSeriesPath(pairs) {
      // We want BAT+ -> (switch closed path) -> R_OUT -> LED_A -> LED_C -> BAT-
      // Simplify: require that all nodes are connected into one component AND switch is closed
      if (!switchClosed.checked) return false;
      return inSameNode('BAT+','R_OUT',pairs) && inSameNode('R_OUT','LED_A',pairs)
             && inSameNode('LED_A','LED_C',pairs) && inSameNode('LED_C','BAT-',pairs);
    }

    function updateBuilder() {
      batteryVLabel.textContent = (+batteryV.value).toFixed(1);
      resLabel.textContent = resistance.value;
      vfLabel.textContent = (+ledVf.value).toFixed(1);

      const pairs = getWires();
      const loopOK = hasSeriesPath(pairs);

      let status = 'Open circuit';
      let I = 0; // amps
      let P = 0;

      if (loopOK) {
        const Vb = +batteryV.value;
        const Vf = +ledVf.value;
        const R = +resistance.value;
        if (Vb > Vf) {
          I = (Vb - Vf) / R; // A
          P = I*I*R + I*Vf;  // resistor + LED power approx
          status = 'Loop complete';
        } else {
          status = 'Battery too low for LED forward bias';
        }
      }

      // UI
      const mA = I * 1000;
      currentEl.textContent = mA.toFixed(2);
      powerEl.textContent = (P*1000).toFixed(2);

      // Ammeter needle: 0 to 30 mA range
      const angle = Math.max(0, Math.min(180, (mA/30)*180));
      ammeter.style.transform = `rotate(${angle}deg)`;

      // LED viz
      const brightness = Math.max(0, Math.min(1, mA / 20)); // brighten near 20 mA
      ledViz.style.opacity = String(0.2 + 0.8*brightness);

      // Status color
      if (mA > 25) {
        status += ' ‚Äî ‚ö†Ô∏è Too much current! Use a larger resistor.';
        statusEl.parentElement.classList.add('warn');
      } else {
        statusEl.parentElement.classList.remove('warn');
      }
      statusEl.textContent = status;
    }

    ['input','change'].forEach(evt => {
      batteryV.addEventListener(evt, updateBuilder);
      resistance.addEventListener(evt, updateBuilder);
      switchClosed.addEventListener(evt, updateBuilder);
      ledVf.addEventListener(evt, updateBuilder);
      document.querySelectorAll('#builder .wire select').forEach(s => s.addEventListener(evt, updateBuilder));
    });
    updateBuilder();

    // ---------- Sensor Lab ----------
    const lightLevel = document.getElementById('lightLevel');
    const threshold = document.getElementById('threshold');
    const lightLabel = document.getElementById('lightLabel');
    const threshLabel = document.getElementById('threshLabel');
    const volume = document.getElementById('volume');
    const isDark = document.getElementById('isDark');
    const alarmState = document.getElementById('alarmState');
    const bulb = document.getElementById('bulb');
    const sensorLed = document.getElementById('sensorLed');

    let audioCtx, osc, gain;

    function ensureAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        osc = audioCtx.createOscillator();
        gain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.value = 600;
        gain.gain.value = 0;
        osc.connect(gain).connect(audioCtx.destination);
        osc.start();
      }
    }

    function updateSensor() {
      lightLabel.textContent = lightLevel.value;
      threshLabel.textContent = threshold.value;

      const dark = (+lightLevel.value) < (+threshold.value);
      isDark.textContent = dark ? 'Yes' : 'No';
      alarmState.textContent = dark ? 'On' : 'Off';

      // visuals
      bulb.style.opacity = String(+lightLevel.value/100);
      sensorLed.style.opacity = dark ? '1' : '0.2';

      // audio
      ensureAudio();
      gain.gain.linearRampToValueAtTime(dark ? +volume.value : 0, audioCtx.currentTime + 0.05);
    }

    ['input','change'].forEach(evt => {
      lightLevel.addEventListener(evt, updateSensor);
      threshold.addEventListener(evt, updateSensor);
      volume.addEventListener(evt, updateSensor);
    });
    updateSensor();

    // ---------- Mystery Fix ----------
    const faultLabel = document.getElementById('faultLabel');
    const mysteryLed = document.getElementById('mysteryLed');
    const mysterySwitch = document.getElementById('mysterySwitch');
    const meterVal = document.getElementById('meterVal');
    const newFaultBtn = document.getElementById('newFault');
    const toggleSwitchBtn = document.getElementById('toggleSwitch');
    const flipLedBtn = document.getElementById('flipLed');
    const replaceBatteryBtn = document.getElementById('replaceBattery');
    const repairWireBtn = document.getElementById('repairWire');
    const winEl = document.getElementById('win');

    let M = {
      Vb: 3.0,
      switchClosed: true,
      ledForward: true,
      openWire: false,
      deadBattery: false,
      Vf: 2.0
    };

    function randomFault() {
      M = {
        Vb: 3.0,
        switchClosed: Math.random() > 0.5,
        ledForward: Math.random() > 0.5,
        openWire: Math.random() > 0.5,
        deadBattery: Math.random() > 0.7,
        Vf: 2.0 + Math.round(Math.random()*6)/10  // 2.0‚Äì2.6 V
      };
      winEl.classList.add('hidden');
      renderMystery();
    }

    function renderMystery() {
      // Determine LED state
      let Vb = M.deadBattery ? 0 : M.Vb;
      let flows = Vb > M.Vf && M.switchClosed && M.ledForward && !M.openWire;
      const ledOn = flows;

      // Update labels
      faultLabel.textContent = 'Unknown (use the meter)';
      mysteryLed.textContent = ledOn ? 'On' : 'Off';
      mysterySwitch.textContent = M.switchClosed ? 'Closed' : 'Open';

      // Win check: if all good and LED on
      if (!M.deadBattery && M.switchClosed && M.ledForward && !M.openWire && (Vb > M.Vf)) {
        faultLabel.textContent = 'Fixed';
        winEl.classList.remove('hidden');
      } else {
        winEl.classList.add('hidden');
      }
    }

    function measure(a, b) {
      // Minimal node model, treat LED like a drop if forward and current could flow
      const Vb = M.deadBattery ? 0 : M.Vb;
      const potentials = {
        'M_BAT+': Vb,
        'M_BAT-': 0,
        'M_SW_IN': Vb,
        'M_SW_OUT': M.switchClosed ? Vb : (M.openWire ? NaN : 0), // open wire may break reference
        'M_LED_A': M.switchClosed ? Vb : (M.openWire ? NaN : 0),
        'M_LED_C': (M.switchClosed && M.ledForward) ? Math.max(0, Vb - M.Vf) : 0
      };

      const Va = potentials[a];
      const Vb_ = potentials[b];

      if (Number.isNaN(Va) || Number.isNaN(Vb_)) return '‚Äî';
      const dv = (Va - Vb_);
      return (Math.round(dv * 100) / 100).toFixed(2) + ' V';
    }

    document.getElementById('measureBtn').addEventListener('click', () => {
      const a = document.getElementById('probeA').value;
      const b = document.getElementById('probeB').value;
      meterVal.textContent = measure(a, b);
    });

    toggleSwitchBtn.addEventListener('click', () => { M.switchClosed = !M.switchClosed; renderMystery(); });
    flipLedBtn.addEventListener('click', () => { M.ledForward = !M.ledForward; renderMystery(); });
    replaceBatteryBtn.addEventListener('click', () => { M.deadBattery = false; M.Vb = 3.0; renderMystery(); });
    repairWireBtn.addEventListener('click', () => { M.openWire = false; renderMystery(); });
    newFaultBtn.addEventListener('click', randomFault);

    randomFault();
  </script>

  <script>
    // ---- Teen Mode + XP + Continuity Beep ----
    const teenMode = document.getElementById('teenMode');
    const advBlocks = document.querySelectorAll('.adv');
    const xpVal = document.getElementById('xpVal');
    let XP = 0;
    function addXP(n){ XP += n; xpVal.textContent = XP; }

    teenMode?.addEventListener('change', () => {
      advBlocks.forEach(el => el.classList.toggle('hidden', !teenMode.checked));
    });

    // Award XP when: good LED current achieved (5-20mA) for the first time
    let goodCurrentAwarded = false;
    const origUpdateBuilder = updateBuilder;
    updateBuilder = function() {
      origUpdateBuilder();
      const mA = parseFloat(document.getElementById('current').textContent);
      if (!goodCurrentAwarded && mA >= 5 && mA <= 20) {
        addXP(10);
        goodCurrentAwarded = true;
      }
      // Fill advanced readouts
      const Vb = +batteryV.value, Vf = +ledVf.value, R = +resistance.value;
      let I = 0, vR = 0, vLED = 0, pR = 0;
      if (switchClosed.checked && (Vb > Vf)) {
        I = (Vb - Vf) / R;
        vR = I * R;
        vLED = Vf;
        pR = I*I*R;
      }
      const vREl = document.getElementById('vR');
      const vLEDEl = document.getElementById('vLED');
      const pREl = document.getElementById('pR');
      if (vREl && vLEDEl && pREl) {
        vREl.textContent = vR.toFixed(2);
        vLEDEl.textContent = vLED.toFixed(2);
        pREl.textContent = (pR*1000).toFixed(2);
      }
    };

    // Continuity beeper for Mystery meter
    const contMode = document.getElementById('contMode');
    let beepCtx, beepOsc, beepGain;
    function ensureBeep() {
      if (!beepCtx) {
        beepCtx = new (window.AudioContext || window.webkitAudioContext)();
        beepOsc = beepCtx.createOscillator();
        beepGain = beepCtx.createGain();
        beepOsc.type = 'sine';
        beepOsc.frequency.value = 1200;
        beepGain.gain.value = 0;
        beepOsc.connect(beepGain).connect(beepCtx.destination);
        beepOsc.start();
      }
    }
    const origMeasure = document.getElementById('measureBtn').onclick;
    document.getElementById('measureBtn').onclick = null;
    document.getElementById('measureBtn').addEventListener('click', () => {
      // Run original measure handler by dispatching click to original listener if needed
      const a = document.getElementById('probeA').value;
      const b = document.getElementById('probeB').value;
      const Vbefore = document.getElementById('meterVal').textContent;
      // Trigger existing logic
      const evt = new Event('click');
      // call the existing measure function directly (we have access to it in scope)
      const val = (function(){
        const Vb = M.deadBattery ? 0 : M.Vb;
        const potentials = {
          'M_BAT+': Vb,
          'M_BAT-': 0,
          'M_SW_IN': Vb,
          'M_SW_OUT': M.switchClosed ? Vb : (M.openWire ? NaN : 0),
          'M_LED_A': M.switchClosed ? Vb : (M.openWire ? NaN : 0),
          'M_LED_C': (M.switchClosed && M.ledForward) ? Math.max(0, Vb - M.Vf) : 0
        };
        const Va = potentials[a], Vb_ = potentials[b];
        if (Number.isNaN(Va) || Number.isNaN(Vb_)) return '‚Äî';
        const dv = (Va - Vb_);
        return (Math.round(dv * 100) / 100).toFixed(2) + ' V';
      })();
      document.getElementById('meterVal').textContent = val;

      if (contMode && contMode.checked) {
        ensureBeep();
        const numeric = parseFloat(String(val).replace(' V',''));
        const closeToZero = !isNaN(numeric) && Math.abs(numeric) < 0.2;
        beepGain.gain.linearRampToValueAtTime(closeToZero ? 0.25 : 0, (beepCtx?.currentTime || 0) + 0.02);
      }
    });

    // Award XP when a Mystery is fixed
    const origRender = renderMystery;
    renderMystery = function(){
      origRender();
      if (faultLabel.textContent === 'Fixed' && !renderMystery._awarded) {
        addXP(20);
        renderMystery._awarded = true;
      }
    };

    // Award XP for Sensor Lab when threshold is tuned right at the edge
    let tunedAward = false;
    const origUpdateSensor = updateSensor;
    updateSensor = function(){
      origUpdateSensor();
      const L = +lightLevel.value, T = +threshold.value;
      if (!tunedAward && Math.abs(L - T) <= 1) {
        addXP(5);
        tunedAward = true;
      }
    };
  </script>


  <script>
    // ===== Logic Lab =====
    const gateSel = document.getElementById('gate');
    const inA = document.getElementById('inA');
    const inB = document.getElementById('inB');
    const logicOut = document.getElementById('logicOut');
    const tBody = document.querySelector('#truthTable tbody');

    function logicEval(g, a, b){
      a = !!a; b = !!b;
      switch(g){
        case 'AND': return a && b;
        case 'OR': return a || b;
        case 'NOT': return !a;
        case 'NAND': return !(a && b);
        case 'NOR': return !(a || b);
        case 'XOR': return (a ^ b) === 1;
      }
      return false;
    }
    function buildTruthTable(){
      if (!tBody) return;
      tBody.innerHTML = '';
      const g = gateSel.value;
      const rows = g === 'NOT' ? [[0,0],[1,0]] : [[0,0],[0,1],[1,0],[1,1]];
      rows.forEach(([A,B]) => {
        const tr = document.createElement('tr');
        const out = logicEval(g, A, B) ? 1 : 0;
        tr.innerHTML = `<td>${A}</td><td>${B}</td><td>${out}</td>`;
        tBody.appendChild(tr);
      });
    }
    function updateLogic(){
      const g = gateSel.value;
      const out = logicEval(g, inA.checked, inB.checked) ? 1 : 0;
      logicOut.textContent = out;
      // Challenge: XOR true when A != B
      if (g === 'XOR' && out === 1) awardChallenge('xorTrue', 'üß† Logic Rookie', 'b_logic');
    }
    ['change','input'].forEach(ev => {
      gateSel?.addEventListener(ev, () => { buildTruthTable(); updateLogic(); });
      inA?.addEventListener(ev, updateLogic);
      inB?.addEventListener(ev, updateLogic);
    });
    buildTruthTable(); updateLogic();

    // ===== PWM Playground =====
    const duty = document.getElementById('duty');
    const freq = document.getElementById('freq');
    const dutyLbl = document.getElementById('dutyLbl');
    const freqLbl = document.getElementById('freqLbl');
    const vavg = document.getElementById('vavg');
    const brightPct = document.getElementById('brightPct');
    const pwmLed = document.getElementById('pwmLed');
    const pwmHigh = document.getElementById('pwmHigh');
    const pwmVolume = document.getElementById('pwmVolume');

    let pwmCtx, pwmOsc, pwmGain;
    function ensurePWM(){
      if (!pwmCtx) {
        pwmCtx = new (window.AudioContext || window.webkitAudioContext)();
        pwmOsc = pwmCtx.createOscillator();
        pwmGain = pwmCtx.createGain();
        pwmOsc.type = 'square';
        pwmOsc.frequency.value = +freq.value;
        pwmGain.gain.value = 0;
        pwmOsc.connect(pwmGain).connect(pwmCtx.destination);
        pwmOsc.start();
      }
    }
    function updatePWM(){
      dutyLbl.textContent = duty.value;
      freqLbl.textContent = freq.value;

      const d = +duty.value / 100;
      const Vb = +document.getElementById('batteryV').value;
      const val = (d * Vb);
      vavg.textContent = val.toFixed(2);
      brightPct.textContent = Math.round(d*100);
      pwmHigh.style.width = (d*100) + '%';
      pwmLed.style.opacity = String(0.2 + 0.8*d);

      ensurePWM();
      pwmOsc.frequency.value = +freq.value;
      pwmGain.gain.linearRampToValueAtTime(+pwmVolume.value * d, pwmCtx.currentTime + 0.03);

      // Challenge: duty near 33%
      if (Math.abs((d*100) - 33) <= 1) {
        awardChallenge('pwm33', 'üì∂ PWM Pilot', 'b_pwm');
      }
    }
    ['input','change'].forEach(ev => {
      duty?.addEventListener(ev, updatePWM);
      freq?.addEventListener(ev, updatePWM);
      pwmVolume?.addEventListener(ev, updatePWM);
    });
    updatePWM();

    // ===== Challenges & Badges =====
    const badgesStrip = document.getElementById('badgesStrip');
    function awardBadge(label, badgeId){
      const badge = document.getElementById(badgeId);
      if (badge && !badge.classList.contains('earned')) {
        badge.classList.add('earned');
        const mini = document.createElement('div');
        mini.className = 'mini-badge';
        mini.textContent = badge.textContent;
        badgesStrip?.appendChild(mini);
        addXP(10);
      }
    }
    function mark(id, ok){
      const el = document.getElementById('c_'+id);
      if (el) el.textContent = ok ? '‚úÖ' : '‚ùå';
    }
    function awardChallenge(id, badgeLabel, badgeElemId){
      if (!awardChallenge._done) awardChallenge._done = {};
      if (awardChallenge._done[id]) return;
      awardChallenge._done[id] = true;
      mark(id, true);
      switch(id){
        case 'safeCurrent':
          awardBadge('LED Tamer', 'b_led'); break;
        case 'sensorEdge':
          awardBadge('Threshold Tuner', 'b_sensor'); break;
        case 'mysteryFix':
          awardBadge('Fault Finder', 'b_fix'); break;
        case 'pwm33':
          awardBadge('PWM Pilot', 'b_pwm'); break;
        case 'xorTrue':
          awardBadge('Logic Rookie', 'b_logic'); break;
      }
      addXP(25);
    }

    // Hook into existing events to award challenge completions
    // Safe current: override updateBuilder wrapper again to check 10‚Äì15mA
    const wasUpdateBuilder = updateBuilder;
    updateBuilder = function(){
      wasUpdateBuilder();
      const mA = parseFloat(document.getElementById('current').textContent);
      if (mA >= 10 && mA <= 15) awardChallenge('safeCurrent', 'üí° LED Tamer', 'b_led');
    };

    // Sensor edge: already implemented tunedAward when |L - T| <= 1 ‚Äî hook it
    const oldUpdateSensor2 = updateSensor;
    updateSensor = function(){
      oldUpdateSensor2();
      const L = +lightLevel.value, T = +threshold.value;
      if (Math.abs(L - T) <= 1) awardChallenge('sensorEdge', 'üëÅÔ∏è Threshold Tuner', 'b_sensor');
    };

    // Mystery fix: hook existing renderMystery
    const oldRender2 = renderMystery;
    renderMystery = function(){
      oldRender2();
      if (faultLabel.textContent === 'Fixed') awardChallenge('mysteryFix', 'üîß Fault Finder', 'b_fix');
    };

    // Study Notes generator
    document.getElementById('downloadNotes')?.addEventListener('click', () => {
      const lines = [];
      lines.push('ElectroPlayground Study Notes');
      lines.push('');
      lines.push('Battery Voltage: ' + document.getElementById('batteryV').value + ' V');
      lines.push('Resistor setting: ' + document.getElementById('resistance').value + ' Œ©');
      lines.push('LED Vf: ' + document.getElementById('ledVf').value + ' V');
      lines.push('Current (series): ' + document.getElementById('current').textContent + ' mA');
      lines.push('PWM Duty: ' + document.getElementById('duty').value + ' %, Frequency: ' + document.getElementById('freq').value + ' Hz');
      lines.push('Logic Gate: ' + gateSel.value + ', A=' + (inA.checked?1:0) + ', B=' + (inB.checked?1:0) + ', Out=' + logicOut.textContent);
      lines.push('');
      lines.push('Achievements:');
      ['safeCurrent','sensorEdge','mysteryFix','pwm33','xorTrue'].forEach(id => {
        const ok = (document.getElementById('c_'+id)?.textContent === '‚úÖ');
        lines.push('- ' + id + ': ' + (ok ? 'Completed' : '‚Äî'));
      });
      const blob = new Blob([lines.join('\n')], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ElectroPlayground_Notes.txt';
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    });
  </script>

</body>
</html>
